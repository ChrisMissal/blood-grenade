<!-- Task Runner UI -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Runner</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header {
      background: white;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-bottom: 10px; }
    .meta { color: #666; font-size: 14px; }
    .content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .panel {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    h2 { color: #333; margin-bottom: 15px; font-size: 18px; }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
    }
    input, textarea, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      font-family: monospace;
    }
    textarea { min-height: 100px; resize: vertical; }
    button {
      background: #667eea;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
    }
    button:hover { background: #5568d3; }
    .task-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .task-item {
      background: #f5f5f5;
      padding: 12px;
      margin-bottom: 10px;
      border-left: 3px solid #667eea;
      border-radius: 3px;
      cursor: pointer;
    }
    .task-item:hover { background: #efefef; }
    .task-name { font-weight: bold; color: #333; }
    .task-status {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 3px;
      font-size: 12px;
      margin-top: 5px;
    }
    .status-pending { background: #ffeaa7; color: #d63031; }
    .status-running { background: #81ecec; color: #0984e3; }
    .status-completed { background: #90ee90; color: #27ae60; }
    .status-failed { background: #ffcccc; color: #d63031; }
    @media (max-width: 768px) {
      .content { grid-template-columns: 1fr; }
    }
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s;
    }
    .output {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 12px;
      border-radius: 5px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 10px;
    }
    .error { color: #f48771; }
    .success { color: #89d185; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸš€ Task Runner</h1>
      <div class="meta" id="meta">Ready to run tasks on Docker with GitHub integration</div>
    </div>

    <div class="content">
      <div class="panel">
        <h2>Create Task</h2>
        <div class="form-group">
          <label>Task Name</label>
          <input type="text" id="taskName" placeholder="e.g., build-app">
        </div>
        <div class="form-group">
          <label>GitHub Repo</label>
          <input type="text" id="githubRepo" placeholder="e.g., owner/repo">
        </div>
        <div class="form-group">
          <label>Docker Image</label>
          <input type="text" id="dockerImage" placeholder="e.g., node:18-alpine">
        </div>
        <div class="form-group">
          <label>Command</label>
          <textarea id="command" placeholder="e.g., npm run build"></textarea>
        </div>
        <div class="form-group">
          <label>Arguments (JSON)</label>
          <textarea id="args" placeholder='{"key": "value"}'>{"key": "value"}</textarea>
        </div>
        <button onclick="createTask()">Create Task</button>
      </div>

      <div class="panel">
        <h2>Tasks</h2>
        <div class="task-list" id="taskList">
          <div style="color: #999;">No tasks yet</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Task Details</h2>
      <div id="taskDetails" style="color: #999;">Select a task to view details</div>
    </div>
  </div>

  <script>
    let tasks = [];
    let selectedTaskId = null;

    async function createTask() {
      const name = document.getElementById('taskName').value;
      const repo = document.getElementById('githubRepo').value;
      const image = document.getElementById('dockerImage').value;
      const cmd = document.getElementById('command').value;
      const args = JSON.parse(document.getElementById('args').value || '{}');

      if (!name || !repo || !image || !cmd) {
        alert('Please fill in all required fields');
        return;
      }

      try {
        const response = await fetch('/api/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name, githubRepo: repo, dockerImage: image, command: cmd, args
          })
        });

        const task = await response.json();
        tasks.push(task);
        renderTasks();

        // Clear form
        document.getElementById('taskName').value = '';
        document.getElementById('githubRepo').value = '';
        document.getElementById('dockerImage').value = '';
        document.getElementById('command').value = '';
        document.getElementById('args').value = '{"key": "value"}';
      } catch (err) {
        alert('Error creating task: ' + err.message);
      }
    }

    function renderTasks() {
      const list = document.getElementById('taskList');
      if (tasks.length === 0) {
        list.innerHTML = '<div style="color: #999;">No tasks yet</div>';
        return;
      }

      list.innerHTML = tasks.map(task => `
        <div class="task-item" onclick="selectTask('${task.id}')">
          <div class="task-name">${task.name}</div>
          <div style="font-size: 12px; color: #666;">
            ${task.githubRepo} â€¢ ${task.dockerImage}
          </div>
          <span class="task-status status-${task.status}">${task.status}</span>
          ${task.progress ? `
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${task.progress}%"></div>
            </div>
          ` : ''}
        </div>
      `).join('');
    }

    function selectTask(taskId) {
      selectedTaskId = taskId;
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;

      let output = task.output || 'No output yet';
      const details = document.getElementById('taskDetails');
      details.innerHTML = `
        <div>
          <h3>${task.name}</h3>
          <p><strong>Status:</strong> <span class="task-status status-${task.status}">${task.status}</span></p>
          <p><strong>Repository:</strong> ${task.githubRepo}</p>
          <p><strong>Docker Image:</strong> ${task.dockerImage}</p>
          <p><strong>Command:</strong> <code>${task.command}</code></p>
          <p><strong>Progress:</strong> ${task.progress || 0}%</p>
          ${task.progress ? `
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${task.progress}%"></div>
            </div>
          ` : ''}
          <button onclick="runTask('${taskId}')" style="margin-right: 10px;">Run Task</button>
          <button onclick="updateArgs('${taskId}')" style="background: #764ba2;">Edit Args</button>
          <div class="output">${output.split('\n').map(line => 
            line.includes('error') ? `<div class="error">${line}</div>` : 
            line.includes('success') ? `<div class="success">${line}</div>` : 
            line
          ).join('')}</div>
        </div>
      `;
    }

    async function runTask(taskId) {
      try {
        const response = await fetch(`/api/tasks/${taskId}/run`, {
          method: 'POST'
        });
        const result = await response.json();
        const task = tasks.find(t => t.id === taskId);
        if (task) {
          task.status = 'running';
          task.progress = 0;
          renderTasks();
          selectTask(taskId);
          pollProgress(taskId);
        }
      } catch (err) {
        alert('Error running task: ' + err.message);
      }
    }

    async function pollProgress(taskId) {
      const poll = setInterval(async () => {
        try {
          const response = await fetch(`/api/tasks/${taskId}/progress`);
          const { progress, status, output } = await response.json();
          const task = tasks.find(t => t.id === taskId);
          if (task) {
            task.progress = progress;
            task.status = status;
            task.output = output;
            renderTasks();
            selectTask(taskId);
            if (status !== 'running') clearInterval(poll);
          }
        } catch (err) {
          console.error('Error polling progress:', err);
          clearInterval(poll);
        }
      }, 500);
    }

    function updateArgs(taskId) {
      const newArgs = JSON.stringify({}, null, 2);
      const task = tasks.find(t => t.id === taskId);
      if (!task) return;
      alert('Edit arguments: ' + JSON.stringify(task.args));
    }

    // Load tasks on startup
    async function loadTasks() {
      try {
        const response = await fetch('/api/tasks');
        tasks = await response.json();
        renderTasks();
      } catch (err) {
        console.error('Error loading tasks:', err);
      }
    }

    loadTasks();
    setInterval(loadTasks, 2000);
  </script>
</body>
</html>
